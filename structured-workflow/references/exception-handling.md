# 异常处理与计划变更程序

本文档定义了结构化工作流中执行阶段的异常处理程序和计划变更流程。

---

## 第一部分：异常处理

执行任务过程中遇到以下 4 种异常情况时，按对应程序处理。

### 异常 1：任务过大

**触发条件**：执行过程中发现任务实际工作量超出预估，无法在当前会话内完成。

**处理程序**：
1. 停止实施，保存当前进度
2. 将任务拆分为子任务（编号格式：`<PREFIX>-XX-a`、`<PREFIX>-XX-b`、`<PREFIX>-XX-c`）
3. 每个子任务必须遵循 `task-format.md` 格式，并满足粒度约束
4. 更新 TASK_PLAN.md（添加子任务，标记原任务为"已拆分"）
5. 更新 TASK_STATUS.md（记录拆分原因）
6. 仅执行第一个子任务（`<PREFIX>-XX-a`），后续子任务留给下次会话
7. 在交接记录中说明拆分情况

### 异常 2：计划有误

**触发条件**：执行过程中发现任务描述与实际代码状态不一致，或方案不可行。

**处理程序**：
1. **立即停止修改**（不要试图"将错就错"修复）
2. 记录发现的问题（预期 vs 实际，为什么方案不可行）
3. 评估影响范围（仅本任务？还是影响后续任务？）
4. 提出修正建议（具体方案，不是笼统建议）
5. 更新 TASK_STATUS.md（在"已知问题"中记录）
6. **等待用户确认**后再继续
7. 如需修改计划，建议用户使用 `/task-plan [变更描述]`

### 异常 3：前置未完成

**触发条件**：任务依赖的前置任务未完成，或前置任务的产出物不存在。

**处理程序**：
1. **立即停止**（不要尝试跳过依赖执行）
2. 明确告知用户哪个前置任务未完成
3. 说明依赖关系（为什么需要前置任务先完成）
4. 建议先执行前置任务
5. 更新 TASK_STATUS.md（记录阻塞原因）

### 异常 4：范围蔓延

**触发条件**：执行过程中发现需要做额外工作，但该工作不在当前任务范围内。

**处理程序**：
1. **完成当前任务范围内的工作**（不要中断）
2. 将范围外的发现记录在交接记录的"遗留问题"中
3. 如果范围外工作是必要的：
   - 建议用户使用 `/task-plan [变更描述]` 新增任务
   - 在交接记录中提供新任务的建议描述
4. **绝对不要**在当前任务中"顺手"做范围外的修改

---

## 第二部分：计划变更

执行过程中发现计划需要调整时，按以下规则处理。

### 变更类型总览

| 变更类型 | 触发时机 | 操作入口 |
|----------|----------|----------|
| **拆分任务** | 当前任务过大 | `/task-exec` 中自动处理（异常 1） |
| **新增任务** | 发现缺少前置/后续工作 | `/task-plan 在<PREFIX>-XX后面加一个XX任务` |
| **删除任务** | 已被其他任务覆盖或不再需要 | `/task-plan 删除<PREFIX>-XX` |
| **修改任务** | 前序任务改变了后续任务的前提 | `/task-plan <PREFIX>-XX方案改为XX` |
| **重排序** | 依赖关系变化 | `/task-plan 调整<PREFIX>-XX和<PREFIX>-YY的顺序` |

### 变更规则

1. **执行中的小变更**（仅拆分当前任务）：在 `/task-exec` 中直接处理
2. **计划层面的变更**（新增/删除/修改/重排序）：使用 `/task-plan [变更描述]`
3. **阶段性批量调整**：在 `/task-review` 中系统性评估后输出调整建议

### 变更记录要求

所有计划变更必须：
- 更新 TASK_PLAN.md（反映变更内容）
- 更新 TASK_STATUS.md（在决策日志中记录变更原因）
- 在交接记录中说明变更的触发原因和影响范围

---

## 第三部分：异常处理决策树

```
执行中遇到问题
  │
  ├── 任务本身的问题？
  │     ├── 工作量超预估 → 异常 1：拆分任务
  │     ├── 任务描述有误 → 异常 2：停止 + 等待确认
  │     └── 前置未完成   → 异常 3：停止 + 告知依赖
  │
  └── 发现额外工作？
        ├── 范围内可处理 → 正常执行
        └── 范围外工作   → 异常 4：记录 + 建议新增任务
```

---

## 第四部分：通用原则

1. **安全优先**：遇到不确定性时，停止并寻求确认，而不是猜测继续
2. **记录一切**：所有异常和变更都必须记录在 TASK_STATUS.md 中
3. **最小影响**：处理异常时，优先选择影响范围最小的方案
4. **保持一致**：新增/修改的任务必须遵循同样的格式和约束规范
5. **不要隐藏问题**：发现的问题必须显式记录，即使暂时无法解决
