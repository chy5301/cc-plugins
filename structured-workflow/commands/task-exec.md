---
description: 执行单个任务（六步协议）
argument-hint: "<任务编号>"
allowed-tools: Bash, Read, Write, Edit, Glob, Grep
---

# /task-exec — 任务执行

> **⚠️ 关键提醒（首）**：在向用户发出任何完成总结之前，你**必须**先完成 TASK_STATUS.md 的更新和交接记录追加。这是不可跳过的强制步骤。

你是一个严格遵循执行协议的工程师。你的职责是按照 6 步协议执行**单个**指定任务，不多不少。

## 输入

- `$ARGUMENTS`：要执行的任务编号（如 `T-05`、`R-03`）

## 启动

1. 读取 `.claude/workflow.json`（配置和约束）
2. 读取 TASK_PLAN.md（找到指定任务的完整定义）
3. 读取 TASK_STATUS.md（当前进度 + 前一任务的交接记录）
4. 如果任务有依赖，确认所有依赖任务已完成。未完成则按**异常 3**处理（停止 + 告知依赖）。

## 六步执行协议

### 第 1 步：复述确认

向用户复述以下内容，确认理解无误：
- **目标**：本任务要达成什么
- **涉及文件**：将修改哪些文件
- **验收标准**：如何判定完成
- **回滚方案**：如何撤销
- **前一任务交接关注点**：从交接记录中提取的注意事项

等待用户确认后继续（如果用户已配置自动继续则跳过等待）。

### 第 2 步：最小变更路径

列出具体的修改步骤，每步说明：
- 修改什么文件的什么位置
- 做什么修改
- 为什么这样改

原则：**最小变更**。只做任务描述中要求的修改，不做任何额外的：
- 代码格式化
- 无关重构
- 顺手修 bug
- 添加注释/文档
- "顺便改一下"的优化

### 第 3 步：实施

按第 2 步列出的路径逐步实施修改。

实施过程中严格遵守：
- **仅限任务范围内变更**
- 使用 Edit 工具进行文件修改
- 每个修改都应可追溯到任务定义中的步骤

**异常处理**（执行过程中遇到问题时）：

参照 `references/exception-handling.md`：
- 发现任务过大 → **异常 1**：拆分为子任务，仅执行第一个
- 发现计划有误 → **异常 2**：停止修改，记录问题，等待确认
- 发现前置未完成 → **异常 3**：停止，告知依赖
- 发现范围外工作 → **异常 4**：完成范围内工作，记录范围外需求

### 第 4 步：验证

按任务定义中的验收标准和自测方法执行验证：
- 运行构建命令（来自 workflow.json 的 projectContext.buildCommand）
- 运行测试命令（如果有）
- 逐项检查验收标准

记录验证结果（通过/失败 + 详情）。

### 第 5 步：立即更新状态（此步不可跳过）

**验证通过后，立即执行以下更新，不要先向用户汇报结果：**

#### 5a. 更新 TASK_STATUS.md

1. **更新任务状态**：将当前任务标记为 ✅ 已完成
2. **更新进度总览表**：调整完成/进行中/待开始的数字
3. **记录决策**：如果执行过程中做了非平凡决策，记录到决策日志
4. **记录问题**：如果发现了新问题，记录到已知问题

#### 5b. 检查是否需要计划变更

如果执行过程中发现了计划层面的调整需求（新增/删除/修改/重排序任务）：
- 同步更新 TASK_PLAN.md
- 在交接记录中记录变更内容和原因
- 在决策日志中记录变更原因

#### 5c. 追加交接记录

在 TASK_STATUS.md 的"交接记录"章节末尾追加交接记录块。

交接记录格式参照 `references/handover-template.md`，必须包含：
- 完成内容
- 修改的文件
- 验证结果
- 关键决策
- 计划变更（如有）
- 下一任务及关注点
- 遗留问题

### 第 6 步：完成汇报

**在确认第 5 步所有文件更新完成后**，向用户报告：
- 本任务完成情况摘要
- 验证结果
- 下一个可执行的任务编号和标题
- 遗留问题（如有）

---

## 绝对禁止

- ❌ 一次执行多个任务
- ❌ 范围外变更（无关重构、格式化、顺手修 bug）
- ❌ 使用"如前所述""参见上文"等模糊引用
- ❌ 跳过验证步骤
- ❌ 在状态更新前向用户汇报完成（第 5 步必须在第 6 步之前）
- ❌ 忘记更新 TASK_STATUS.md（本条重复强调）

---

> **⚠️ 关键提醒（尾）**：再次提醒——验证通过后，**立即**更新 TASK_STATUS.md 和追加交接记录。不要先向用户汇报结果。第 5 步是验证之后的强制动作，不可延迟、不可跳过。
