# 分类型规划 Prompt

本文档包含 8 种任务类型的规划 prompt。`/task-plan` 根据 `primaryType` 加载对应章节。

---

## 通用规划原则

无论哪种类型，规划阶段都必须遵循以下原则：

1. **粒度约束**：每个任务的涉及文件数和预估工时不超过 `workflow.json` 中的配置
2. **自包含描述**：每个任务的背景信息必须自包含
3. **显式依赖**：任务间的依赖关系必须显式声明
4. **格式规范**：所有任务遵循 `${CLAUDE_PLUGIN_ROOT}/references/task-format.md` 格式
5. **阶段划分**：任务按阶段组织，每阶段有明确的退出标准

---

## feature — 新功能开发规划

### 策略选项

| 策略 | 适用场景 | 特点 |
|------|----------|------|
| **纵切**（推荐） | 功能可按用户场景切分 | 每个切片都是可工作的端到端功能 |
| **横切** | 功能有明确的技术层次 | 按层（数据→逻辑→UI）逐层构建 |
| **由内而外** | 核心算法/逻辑复杂 | 先构建核心，再逐层包裹外围 |

### 默认阶段

| 阶段 | 名称 | 退出标准 |
|------|------|----------|
| Phase 0 | 基础设施 | 项目骨架和依赖就绪，空壳可编译 |
| Phase 1 | 核心逻辑 | 核心功能逻辑实现并通过单元测试 |
| Phase 2 | 集成 | 与现有系统集成完成，端到端流程可运行 |
| Phase 3 | 打磨 | UI/UX 完善、边缘用例处理、错误处理 |
| Phase 4 | 发布准备 | 文档、测试覆盖、性能验证全部完成 |

### 规划要点
- 优先实现最小可验证功能（MVP）
- 每个阶段结束时应有可演示的产出
- 集成测试在 Phase 2 后持续运行

---

## refactor — 代码重构规划

### 策略选项

| 策略 | 适用场景 | 特点 |
|------|----------|------|
| **Strangler Fig**（推荐） | 大型遗留系统 | 新旧共存，逐步替换 |
| **接口优先** | 接口清晰的系统 | 先统一接口，再替换实现 |
| **平行双跑** | 高风险场景 | 新旧同时运行，对比验证 |

### 默认阶段

| 阶段 | 名称 | 退出标准 |
|------|------|----------|
| Phase 0 | 脚手架 | 新结构就位，新旧代码可共同编译 |
| Phase 1 | 最小端到端 | 一个核心功能通过新架构完整运行 |
| Phase 2 | 逐模块迁移 | 所有模块按新架构运行 |
| Phase 3 | 清理 | 旧代码移除，无废弃引用 |
| Phase 4 | 验证 | 全量回归测试通过，性能达标 |

### 规划要点
- 每个任务必须保持系统可编译可运行
- 优先处理耦合最紧密的模块
- 接口变更任务放在实现变更之前
- 清理任务集中在最后阶段

---

## migration — 技术迁移规划

### 策略选项

| 策略 | 适用场景 | 特点 |
|------|----------|------|
| **并行运行**（推荐） | 高可用要求 | 新旧系统并行，渐进切换 |
| **特性开关** | 可按功能切换 | 通过开关控制新旧路径 |
| **蓝绿部署** | 部署级切换 | 整体切换，快速回滚 |

### 默认阶段

| 阶段 | 名称 | 退出标准 |
|------|------|----------|
| Phase 0 | 准备 | 目标环境就绪，迁移工具可用 |
| Phase 1 | 双写 | 数据同时写入新旧系统 |
| Phase 2 | 迁移 | 历史数据迁移完成，数据一致性验证通过 |
| Phase 3 | 切换 | 读流量切换到新系统，旧系统降级为备份 |
| Phase 4 | 清理 | 旧系统下线，迁移工具移除 |

### 规划要点
- 数据迁移任务必须包含回滚方案
- 每个阶段要有数据一致性验证
- 兼容期的持续时间需要明确
- 监控和告警在 Phase 0 就要准备好

---

## integration — 系统集成规划

### 策略选项

| 策略 | 适用场景 | 特点 |
|------|----------|------|
| **适配器模式**（推荐） | 外部系统 API 不可控 | 适配层隔离外部变化 |
| **网关模式** | 多外部系统统一接入 | 统一入口，集中管理 |
| **直连模式** | 简单稳定的 API | 减少中间层，简化架构 |

### 默认阶段

| 阶段 | 名称 | 退出标准 |
|------|------|----------|
| Phase 0 | 契约确认 | 接口契约文档化，Mock 服务可用 |
| Phase 1 | 适配层 | 适配器/网关实现完成，单元测试通过 |
| Phase 2 | 联调 | 与真实外部系统连通，基本流程通过 |
| Phase 3 | 端到端 | 所有业务场景通过端到端测试 |
| Phase 4 | 稳定化 | 异常处理、重试、监控就绪 |

### 规划要点
- 先用 Mock 开发，再联调真实系统
- 异常处理和超时策略不能推迟到最后
- 接口版本策略要在 Phase 0 确定

---

## optimization — 性能优化规划

### 策略选项

| 策略 | 适用场景 | 特点 |
|------|----------|------|
| **热点优先**（推荐） | 瓶颈集中 | 优先处理最大瓶颈，收益最大化 |
| **自顶向下** | 架构级问题 | 从架构层面开始优化 |
| **自底向上** | 微优化积累 | 从基础操作开始逐层优化 |

### 默认阶段

| 阶段 | 名称 | 退出标准 |
|------|------|----------|
| Phase 0 | 基准建立 | 基准测试就绪，当前指标已记录 |
| Phase 1 | 关键路径 | 最大瓶颈优化完成，指标提升可测量 |
| Phase 2 | 次要路径 | 次要瓶颈优化完成 |
| Phase 3 | 验证 | 全量性能测试通过，无功能回归 |
| Phase 4 | 监控 | 性能监控和告警就绪 |

### 规划要点
- 每个优化任务必须有可测量的目标
- 先建基准，再优化，避免无度量的优化
- 每次优化后都要验证功能正确性
- 避免过早优化和微优化

---

## bugfix — 大规模缺陷修复规划

### 策略选项

| 策略 | 适用场景 | 特点 |
|------|----------|------|
| **根因优先**（推荐） | 多缺陷同根因 | 修复根因消除一批缺陷 |
| **逐缺陷** | 缺陷相互独立 | 逐个修复，各自验证 |
| **按模块批量** | 缺陷集中在特定模块 | 按模块组织修复 |

### 默认阶段

| 阶段 | 名称 | 退出标准 |
|------|------|----------|
| Phase 0 | 复现 | 所有缺陷可稳定复现，测试用例就绪 |
| Phase 1 | 定位 | 所有缺陷根因定位完成 |
| Phase 2 | 修复 | 修复实施完成，单元测试通过 |
| Phase 3 | 回归 | 全量回归测试通过，无新缺陷 |
| Phase 4 | 加固 | 防御性代码和监控就绪 |

### 规划要点
- 先复现再修复，避免盲目修改
- 每个修复任务必须附带回归测试
- 同根因的缺陷合并处理

---

## infrastructure — 基础设施规划

### 策略选项

| 策略 | 适用场景 | 特点 |
|------|----------|------|
| **增量构建**（推荐） | 在现有设施上改进 | 风险低，逐步改善 |
| **并行搭建** | 需要全新环境 | 新旧并行，对比验证 |
| **迁移式替换** | 旧设施无法改进 | 搭建新设施后整体迁移 |

### 默认阶段

| 阶段 | 名称 | 退出标准 |
|------|------|----------|
| Phase 0 | 规划 | 架构方案确认，工具链就绪 |
| Phase 1 | 搭建 | 核心组件部署完成 |
| Phase 2 | 迁移 | 现有项目/流程迁移完成 |
| Phase 3 | 验证 | 端到端流程验证通过 |
| Phase 4 | 文档化 | 操作手册和维护文档完成 |

### 规划要点
- 变更要有回滚方案
- 先在非生产环境验证
- 文档化是必须的（不是可选的）

---

## generic — 通用规划

### 策略选项
用户自定义，Claude 根据任务分析结果建议策略。

### 默认阶段
用户自定义，Claude 根据任务复杂度建议阶段划分。建议 3~5 个阶段。

### 规划要点
- 应用通用的粒度约束和格式规范
- 每个阶段有明确退出标准
- 依赖关系显式声明

---

## 规划输出文件

### TASK_PLAN.md 格式

```markdown
# 任务计划

## 总体策略
[策略名称 + 选择理由]

## 阶段里程碑
[各阶段名称、目标、退出标准]

## 任务列表

### Phase 0: [阶段名称]

#### [PREFIX-01] 动词-对象 标题
...（按 task-format.md 格式）

### Phase 1: [阶段名称]
...
```

### TASK_STATUS.md 格式

```markdown
# 任务状态跟踪

## 进度总览

| 阶段 | 总数 | 完成 | 进行中 | 待开始 |
|------|------|------|--------|--------|
| Phase 0 | N | 0 | 0 | N |
| Phase 1 | N | 0 | 0 | N |
| **合计** | **N** | **0** | **0** | **N** |

## 任务状态

| 编号 | 标题 | 阶段 | 状态 | 依赖 |
|------|------|------|------|------|
| PREFIX-01 | ... | Phase 0 | ⬜ 待开始 | 无 |

状态图例: ⬜ 待开始 | 🔄 进行中 | ✅ 已完成 | ⏸️ 暂停 | ❌ 已取消 | 🔀 已拆分

## 已知问题

（执行过程中发现的问题记录在此）

## 决策日志

（重要决策和变更原因记录在此）

## 交接记录

（每次 /task-exec 完成后在此追加交接记录块）
```
