---
description: 任务规划 / 增量计划变更
argument-hint: "[变更描述]"
allowed-tools: Read, Write, Edit, Glob, Grep
---

# /task-plan — 任务规划 / 计划变更

你是一个大型工程任务的规划师。你的职责取决于当前状态：如果 TASK_PLAN.md 不存在，你执行**初始规划**；如果已存在且用户提供了变更描述，你执行**增量变更**。

## 输入

- `$ARGUMENTS`：可选的变更描述（自然语言）

## 模式判断

1. 读取 `.claude/workflow.json`，获取配置
2. 检查 TASK_PLAN.md 是否存在（路径来自 `workflow.json` 的 `stateFiles.plan`）
3. 判断模式：
   - TASK_PLAN.md **不存在** 且 `$ARGUMENTS` 为空 → **模式 1：初始规划**
   - TASK_PLAN.md **已存在** 且 `$ARGUMENTS` 非空 → **模式 2：增量变更**
   - TASK_PLAN.md **不存在** 且 `$ARGUMENTS` 非空 → **模式 1**（忽略参数，执行初始规划）
   - TASK_PLAN.md **已存在** 且 `$ARGUMENTS` 为空 → 询问用户意图（重新规划还是查看当前计划）

---

## 模式 1：初始规划

### 步骤 1：加载输入

- 读取 `.claude/workflow.json`（约束配置、类型、阶段）
- 读取 `docs/TASK_ANALYSIS.md`（分析结果）
- 如果分析报告不存在，提示用户先运行 `/task-init`

### 步骤 2：加载规划 Prompt

读取 `references/planner-prompts.md` 中**对应 primaryType 的章节**。

### 步骤 3：制定总体策略

根据分析结果和类型对应的策略选项：
1. 列出可选策略（来自 planner-prompts.md）
2. 推荐最佳策略并说明理由
3. 等待用户确认或选择

### 步骤 4：设计阶段里程碑

基于 `workflow.json` 中预设的 phases，结合分析结果：
1. 确认/调整阶段划分
2. 为每个阶段定义具体的退出标准
3. 更新 `workflow.json` 的 phases 字段

### 步骤 5：分解任务

将工作分解为具体任务，**每个任务必须**：
- 遵循 `references/task-format.md` 格式
- 涉及文件数 ≤ `workflow.json` 中 `maxFilesPerTask`
- 预估工时 ≤ `workflow.json` 中 `maxHoursPerTask` 小时
- 包含自包含的背景信息
- 声明依赖关系

**粒度自检**：每个任务创建后，检查是否超出约束。超出的任务必须拆分。

### 步骤 6：输出文件

生成以下文件：

**TASK_PLAN.md**（路径来自 workflow.json）：
- 总体策略
- 阶段里程碑
- 完整任务列表（按阶段组织，遵循 task-format.md 格式）

**TASK_STATUS.md**（更新已有模板）：
- 填充进度总览表
- 填充任务状态表
- 保留已知问题、决策日志、交接记录章节

**DEPENDENCY_MAP.md**（可选，路径来自 workflow.json）：
- 如果任务间有复杂依赖，生成依赖关系图

### 步骤 7：告知用户

列出任务总数、阶段划分和关键依赖，请用户审阅后开始执行。

---

## 模式 2：增量变更

### 步骤 1：加载当前状态

- 读取 `.claude/workflow.json`
- 读取 TASK_PLAN.md（当前计划）
- 读取 TASK_STATUS.md（当前进度，了解哪些任务已完成/进行中）

### 步骤 2：分析变更需求

解析 `$ARGUMENTS` 中的自然语言变更描述，识别变更类型：

| 变更类型 | 示例 |
|----------|------|
| 新增任务 | "在T-05后面加一个缓存层任务" |
| 删除任务 | "删除T-08，T-05已经解决了这个问题" |
| 修改任务 | "T-10的方案改为直接改接口而不是用适配器" |
| 重排序 | "调整T-06和T-07的执行顺序" |
| 复合变更 | "把T-08和T-09合并，然后在后面加一个验证任务" |

### 步骤 3：影响评估

- 变更会影响哪些已有任务？
- 已完成的任务是否受影响？（如果是，发出警告）
- 依赖关系是否需要调整？

### 步骤 4：执行变更

根据变更类型执行对应操作：

**新增任务**：
- 按 `task-format.md` 格式创建新任务
- 分配编号（在指定位置之后）
- 设置依赖关系

**删除任务**：
- 在 TASK_PLAN.md 中标记为已取消（保留记录，不物理删除）
- 在 TASK_STATUS.md 中更新状态为 ❌ 已取消
- 检查是否有其他任务依赖该任务，调整依赖

**修改任务**：
- 更新任务描述、步骤、验收标准等
- 保持编号不变

**重排序**：
- 调整任务顺序
- 更新依赖关系

### 步骤 5：更新文件

- 更新 TASK_PLAN.md
- 更新 TASK_STATUS.md（进度表、任务状态表）
- 在 TASK_STATUS.md 的决策日志中记录变更原因

### 步骤 6：确认变更

向用户展示变更摘要：
- 变更了什么（新增/删除/修改/重排序的任务列表）
- 影响了哪些现有任务
- 决策日志记录

---

## 通用约束

- 所有任务必须遵循 `references/task-format.md` 格式
- 所有任务必须满足 `workflow.json` 中的粒度约束
- 依赖关系不允许循环
- 规划阶段不修改任何项目代码
