# 分类型分析 Prompt

本文档包含 8 种任务类型的分析 prompt。`/task-init` 根据 `primaryType` 加载对应章节，`secondaryTags` 对应的补充检查项附加到主分析中。

---

## 任务类型枚举与分诊规则

| 类型 | 定义边界 | 典型信号词 |
|------|----------|------------|
| `feature` | 添加新功能模块 | "新增""添加""开发""实现" |
| `refactor` | 改善代码结构，不改变外部行为 | "重构""重写""重新组织""整理""合并代码" |
| `migration` | 技术栈/平台/数据迁移 | "迁移""升级""从X到Y""切换到" |
| `integration` | 接入外部系统或服务 | "集成""对接""接入""联调" |
| `optimization` | 提升性能指标 | "优化""加速""减少延迟""降低内存" |
| `bugfix` | 大规模缺陷/安全漏洞修复 | "修复""修复一批""安全加固" |
| `infrastructure` | CI/CD、监控、部署架构 | "CI""部署""监控""Docker""流水线" |
| `generic` | 以上都不适用 | — |

**分诊规则**：
- `refactor` vs `optimization`：refactor 侧重结构改善，optimization 侧重可度量的性能指标
- `migration` vs `refactor`：migration 涉及技术栈/平台切换，refactor 在同一技术栈内改善
- `feature` vs `integration`：feature 是自研功能，integration 是接入外部系统
- `bugfix` 仅用于大规模/系统性修复，单个 bug 修复不需要此工作流

---

## feature — 新功能开发分析

### 分析目标
为新功能的开发建立完整的技术基础，明确集成策略和风险点。

### 分析任务

#### 1. 现有架构扫描
- 项目整体架构和模块划分
- 新功能的目标集成位置
- 现有模块间的依赖关系
- 可复用的现有组件/模式

#### 2. 集成点分析
- 新功能需要与哪些现有模块交互
- 接口定义（输入/输出/事件）
- 数据流方向和格式
- 新增的外部依赖

#### 3. API 变更面
- 新增的公共 API
- 对现有 API 的修改（如有）
- 向后兼容性分析
- API 版本策略

#### 4. 测试覆盖缺口
- 现有测试覆盖情况
- 新功能需要的测试类型
- 集成测试策略
- 端到端测试需求

#### 5. 风险点识别
- 技术风险（性能、兼容性、安全）
- 依赖风险（第三方库、外部服务）
- 范围风险（需求模糊点）

### 输出格式
```markdown
# 任务分析报告

## 项目概述
[项目简述、技术栈、架构模式]

## 现有架构
[模块划分、依赖关系图]

## 集成分析
[集成点、接口清单、数据流]

## API 变更
[新增/修改的 API、兼容性分析]

## 测试策略
[测试覆盖现状、新增测试需求]

## 风险清单
[风险项 + 缓解措施]

## 待确认问题
[需要用户决策或澄清的问题]
```

---

## refactor — 代码重构分析

### 分析目标
全面理解现有代码结构、接口契约和耦合关系，为安全重构建立基础。

### 分析任务

#### 1. 架构扫描
- 模块结构和职责划分
- 依赖关系（正向和反向）
- 架构模式（MVC、分层、事件驱动等）
- 代码组织问题（循环依赖、过度耦合）

#### 2. 接口契约清单
- 所有公共接口定义
- 接口间的调用关系
- 数据类型和转换点
- 隐式契约（未文档化的行为依赖）

#### 3. 耦合风险点
- 最危险的依赖关系（修改一处影响多处）
- 全局状态的使用
- 构建系统耦合
- 跨模块的隐式假设

#### 4. 待确认问题
- 模糊的设计意图
- 可能的行为保留需求
- 测试覆盖缺口

### 输出格式
```markdown
# 任务分析报告

## 项目概述
[项目简述、技术栈、当前架构]

## 架构扫描
[模块结构、依赖图、架构模式]

## 接口契约清单
[接口列表、调用关系、数据流]

## 耦合风险点
[高风险区域、影响评估]

## 重构范围建议
[建议的重构边界和优先级]

## 待确认问题
[需要用户决策或澄清的问题]
```

---

## migration — 技术迁移分析

### 分析目标
建立源系统和目标系统的完整映射，识别迁移路径和兼容性风险。

### 分析任务

#### 1. 源/目标系统映射
- 源技术栈的组件清单
- 目标技术栈的对应组件
- 功能对等性分析（哪些功能有直接对应，哪些需要适配）

#### 2. 数据模型差异
- 数据结构对比
- 字段映射关系
- 数据类型转换需求
- 数据完整性约束差异

#### 3. API 兼容性
- 源系统 API 清单
- 目标系统 API 对应
- 不兼容点和适配方案
- 过渡期兼容策略

#### 4. 迁移风险
- 数据丢失风险
- 功能缺失风险
- 性能变化风险
- 回滚复杂度

### 输出格式
```markdown
# 任务分析报告

## 迁移概述
[源系统→目标系统、迁移动机]

## 系统映射
[组件对应关系、功能对等性]

## 数据模型差异
[结构对比、转换需求]

## API 兼容性分析
[兼容/不兼容项、适配方案]

## 风险评估
[风险清单 + 缓解措施]

## 迁移策略建议
[推荐的迁移方式、过渡期策略]

## 待确认问题
[需要用户决策或澄清的问题]
```

---

## integration — 系统集成分析

### 分析目标
全面理解系统间的交互需求，建立接口契约和数据流映射。

### 分析任务

#### 1. 系统间接口契约
- 外部系统的 API 文档梳理
- 认证/授权方式
- 请求/响应格式
- 错误码和异常处理

#### 2. 协议映射
- 通信协议（HTTP/gRPC/WebSocket/UDP 等）
- 序列化格式（JSON/Protobuf/二进制等）
- 编码和字节序
- 超时和重试策略

#### 3. 数据流分析
- 数据流方向和频率
- 数据转换需求
- 缓冲和队列策略
- 数据一致性保证

#### 4. 时序约束
- 启动/关闭顺序
- 心跳和健康检查
- 故障切换流程
- 并发和竞态条件

### 输出格式
```markdown
# 任务分析报告

## 集成概述
[本系统与外部系统的关系、集成目标]

## 接口契约
[API 清单、认证方式、数据格式]

## 协议分析
[通信协议、序列化、字节序]

## 数据流
[数据流图、转换需求、一致性]

## 时序约束
[启停顺序、心跳、故障处理]

## 风险清单
[风险项 + 缓解措施]

## 待确认问题
[需要用户决策或澄清的问题]
```

---

## optimization — 性能优化分析

### 分析目标
通过基准测量和瓶颈识别，建立可度量的优化目标和优先级。

### 分析任务

#### 1. 瓶颈识别
- 性能瓶颈定位（CPU/内存/IO/网络）
- 热点代码路径
- 资源使用模式
- 并发/锁竞争分析

#### 2. 基准测量
- 现有性能指标
- 目标性能指标
- 测量方法和工具
- 可重复的基准测试

#### 3. 优化依赖顺序
- 优化项之间的依赖关系
- 收益/成本比排序
- 优化的叠加效应分析

#### 4. 回归风险
- 优化可能引入的功能回归
- 正确性验证策略
- 性能回归检测

### 输出格式
```markdown
# 任务分析报告

## 优化概述
[当前性能状况、优化目标]

## 瓶颈分析
[瓶颈列表、热点路径]

## 基准数据
[当前指标、目标指标、测量方法]

## 优化优先级
[按收益/成本比排序的优化项]

## 风险评估
[回归风险、正确性保证]

## 待确认问题
[需要用户决策或澄清的问题]
```

---

## bugfix — 大规模缺陷修复分析

### 分析目标
系统性定位缺陷的影响范围和根因，建立修复优先级和回归测试策略。

### 分析任务

#### 1. 影响范围扫描
- 受影响的模块和功能
- 用户影响面（严重程度 × 影响范围）
- 数据完整性影响

#### 2. 根因分析
- 缺陷的根本原因（vs 表面症状）
- 同类缺陷扫描（同一根因是否有其他表现）
- 引入时间和原因

#### 3. 回归风险
- 修复可能影响的其他功能
- 现有测试覆盖情况
- 需要新增的测试

### 输出格式
```markdown
# 任务分析报告

## 缺陷概述
[缺陷描述、严重程度、影响范围]

## 根因分析
[根本原因、引入时间、同类扫描]

## 影响评估
[受影响模块、用户影响面]

## 修复策略
[修复方案、优先级排序]

## 回归测试策略
[测试覆盖、新增测试需求]

## 待确认问题
[需要用户决策或澄清的问题]
```

---

## infrastructure — 基础设施分析

### 分析目标
审计现有基础设施，建立改造方案和迁移路径。

### 分析任务

#### 1. 现有设施审计
- 当前 CI/CD 配置
- 部署架构和环境
- 监控和告警覆盖
- 安全配置

#### 2. 依赖关系
- 基础设施组件间的依赖
- 对应用代码的约束
- 环境差异（开发/测试/生产）

#### 3. 改造评估
- 当前痛点和改进空间
- 改造优先级
- 兼容性约束

### 输出格式
```markdown
# 任务分析报告

## 基础设施概述
[当前设施清单、架构图]

## 审计结果
[各组件状态、问题清单]

## 依赖分析
[组件依赖、环境差异]

## 改造建议
[改造方案、优先级、风险]

## 待确认问题
[需要用户决策或澄清的问题]
```

---

## generic — 通用分析

### 分析目标
通用分析模板，适用于不属于以上任何类型的任务。

### 分析任务

#### 1. 现状分析
- 当前系统/代码/流程的状态
- 主要组件和关系

#### 2. 目标定义
- 预期的最终状态
- 成功标准

#### 3. 差距分析
- 现状与目标之间的差距
- 需要解决的核心问题

#### 4. 风险识别
- 技术风险
- 流程风险
- 依赖风险

### 输出格式
```markdown
# 任务分析报告

## 项目概述
[项目简述、背景]

## 现状分析
[当前状态、组件关系]

## 目标定义
[预期结果、成功标准]

## 差距分析
[差距清单、核心问题]

## 风险清单
[风险项 + 缓解措施]

## 待确认问题
[需要用户决策或澄清的问题]
```

---

## 补充检查项（Secondary Tags）

当任务有 `secondaryTags` 时，在主分析中附加对应的补充检查项。

### refactor 标签补充项
- [ ] 架构耦合点是否已识别
- [ ] 接口变更是否有兼容方案

### integration 标签补充项
- [ ] 外部系统接口是否已确认
- [ ] 通信协议是否已明确

### migration 标签补充项
- [ ] 数据迁移方案是否已规划
- [ ] 回滚方案是否可行

### optimization 标签补充项
- [ ] 基准数据是否已采集
- [ ] 性能目标是否已量化

### bugfix 标签补充项
- [ ] 根因是否已定位
- [ ] 回归测试策略是否已规划
