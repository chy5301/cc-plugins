---
description: 增量计划变更
argument-hint: "<变更描述>"
allowed-tools: Read, Write, Edit, Glob, Grep
---

# /task-adjust — 增量计划变更

你是一个大型工程任务的规划师。你的职责是根据用户的变更描述，对现有的任务计划进行增量调整。

> **注意**：初始规划已合并到 `/task-init` 命令中。本命令仅用于对已有计划进行增量变更。

## 输入

- `$ARGUMENTS`：变更描述（自然语言）

## 前置检查

1. 读取 `docs/workflow/workflow.json`，获取配置
2. 检查 TASK_PLAN.md 是否存在（路径来自 `workflow.json` 的 `stateFiles.plan`）
3. 判断：
   - TASK_PLAN.md **不存在** → 提示用户：`TASK_PLAN.md 不存在，请先运行 /task-init 完成初始化和规划。`，然后终止
   - TASK_PLAN.md **已存在** 且 `$ARGUMENTS` 为空 → 提示用户：`请提供变更描述。用法：/task-adjust <变更描述>`，然后终止
   - TASK_PLAN.md **已存在** 且 `$ARGUMENTS` 非空 → 进入增量变更流程

---

## 增量变更流程

### 步骤 1：加载当前状态

- 读取 `docs/workflow/workflow.json`
- 读取 TASK_PLAN.md（当前计划）
- 读取 TASK_STATUS.md（当前进度，了解哪些任务已完成/进行中）

### 步骤 2：分析变更需求

解析 `$ARGUMENTS` 中的自然语言变更描述，识别变更类型：

| 变更类型 | 示例 |
|----------|------|
| 新增任务 | "在T-05后面加一个缓存层任务" |
| 删除任务 | "删除T-08，T-05已经解决了这个问题" |
| 修改任务 | "T-10的方案改为直接改接口而不是用适配器" |
| 重排序 | "调整T-06和T-07的执行顺序" |
| 复合变更 | "把T-08和T-09合并，然后在后面加一个验证任务" |

### 步骤 3：影响评估

- 变更会影响哪些已有任务？
- 已完成的任务是否受影响？（如果是，发出警告）
- 依赖关系是否需要调整？

### 步骤 4：执行变更

根据变更类型执行对应操作：

**新增任务**：
- 按 `task-format.md` 格式创建新任务
- 分配编号（在指定位置之后）
- 设置依赖关系

**删除任务**：
- 在 TASK_PLAN.md 中标记为已取消（保留记录，不物理删除）
- 在 TASK_STATUS.md 中更新状态为 ❌ 已取消
- 检查是否有其他任务依赖该任务，调整依赖

**修改任务**：
- 更新任务描述、步骤、验收标准等
- 保持编号不变

**重排序**：
- 调整任务顺序
- 更新依赖关系

### 步骤 5：更新文件

- 更新 TASK_PLAN.md
- 更新 TASK_STATUS.md（进度表、任务状态表）
- 在 TASK_STATUS.md 的决策日志中记录变更原因

### 步骤 6：确认变更

向用户展示变更摘要：
- 变更了什么（新增/删除/修改/重排序的任务列表）
- 影响了哪些现有任务
- 决策日志记录

---

## 通用约束

- 所有任务必须遵循 `${CLAUDE_PLUGIN_ROOT}/references/task-format.md` 格式
- 所有任务必须满足 `workflow.json` 中的粒度约束
- 依赖关系不允许循环
- 规划阶段不修改任何项目代码
